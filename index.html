<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Taratasiko - Coursiers Administratifs</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        :root {
            --primary: rgb(0, 14, 66);
            --secondary: rgb(255, 49, 49);
            --accent: #FFA726;
            --text: #2D3748;
            --light: #F7FAFC;
            --white: #FFFFFF;
            --dark: #1A202C;
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Poppins', sans-serif;
        }
        
        body {
            background-color: var(--light);
            color: var(--text);
            overflow-x: hidden;
            max-width: 414px;
            margin: 0 auto;
            position: relative;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
            min-height: 100vh;
        }
        
        /* Splash Screen comme une vraie APK */
        .splash {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--primary);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            animation: fadeOut 1s 2.5s forwards;
        }
        
        .splash-logo {
            width: 150px;
            margin-bottom: 20px;
            animation: pulse 1.5s infinite alternate;
        }
        
        .splash-text {
            color: var(--white);
            font-size: 18px;
            opacity: 0;
            animation: fadeIn 0.5s 1s forwards;
        }
        
        @keyframes pulse {
            from { transform: scale(1); }
            to { transform: scale(1.1); }
        }
        
        @keyframes fadeIn {
            to { opacity: 1; }
        }
        
        @keyframes fadeOut {
            to { opacity: 0; visibility: hidden; }
        }
        
        /* Header Principal */
        .header {
            background: linear-gradient(135deg, var(--primary), #004080);
            color: var(--white);
            padding: 30px 20px 40px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }
        
        .header h1 {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 10px;
            animation: fadeInDown 0.8s both;
        }
        
        .header p {
            font-size: 14px;
            margin-bottom: 5px;
            opacity: 0.9;
            animation: fadeInDown 0.8s 0.2s both;
        }
        
        /* Bouton Principal */
        .btn-primary {
            background: var(--secondary);
            color: var(--white);
            border: none;
            border-radius: 30px;
            padding: 15px 30px;
            font-size: 16px;
            font-weight: 600;
            margin: 15px auto;
            display: block;
            width: 80%;
            box-shadow: 0 4px 15px rgba(255, 102, 0, 0.4);
            transition: all 0.3s ease;
            cursor: pointer;
            text-decoration: none;
            text-align: center;
        }
        
        /* Sections conformes à Canva */
        .section {
            padding: 25px 20px;
            margin: 15px;
            background: var(--white);
            border-radius: 15px;
            box-shadow: var(--shadow);
            animation: fadeInUp 0.8s both;
        }
        
        .section h2 {
            color: var(--primary);
            margin-bottom: 15px;
            font-size: 20px;
            display: flex;
            align-items: center;
        }
        
        .section h2 i {
            margin-right: 10px;
            color: var(--secondary);
        }
        
        /* Nos Valeurs */
        .values {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            margin-top: 20px;
        }
        
        .value-item {
            width: 48%;
            margin-bottom: 15px;
            padding: 15px;
            background: rgba(0, 51, 102, 0.05);
            border-radius: 10px;
            text-align: center;
        }
        
        .value-item i {
            font-size: 24px;
            color: var(--secondary);
            margin-bottom: 10px;
        }
        
        /* Comment ça marche */
        .steps {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-top: 20px;
        }
        
        .step {
            display: flex;
            align-items: flex-start;
        }
        
        .step-number {
            background: var(--primary);
            color: var(--white);
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            flex-shrink: 0;
        }
        
        /* Paiement Mobile Money avec fond noir */
        .payment-methods {
            display: flex;
            justify-content: space-around;
            margin: 25px 0;
            background: var(--dark);
            padding: 20px;
            border-radius: 15px;
        }
        
        .payment-method {
            text-align: center;
            padding: 10px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            background: var(--dark);
        }
        
        .payment-method.selected {
            background: rgba(255, 255, 255, 0.1);
        }
        
        .payment-method img {
            width: 40px;
            height: 40px;
            object-fit: contain;
            margin-bottom: 5px;
        }
        
        .payment-method p {
            color: var(--white);
            font-size: 12px;
        }
        
        /* Confirmation et Suivi */
        .confirmation-section {
            display: none;
            text-align: center;
            padding: 30px 20px;
        }
        
        .confirmation-icon {
            font-size: 60px;
            color: var(--secondary);
            margin-bottom: 20px;
        }
        
        /* Footer avec contacts */
        .footer {
            background: var(--primary);
            color: var(--white);
            padding: 25px 20px;
            text-align: center;
        }
        
        .footer p {
            margin-bottom: 10px;
            font-size: 14px;
        }
        
        .footer .contct {
            color: var(--secondary);
            text-decoration: none;
        }
        
        /* Animations */
        @keyframes fadeInDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        /* Histoire complète (cachée initialement) */
        .full-story {
            display: none;
            padding-top: 15px;
            animation: fadeIn 0.5s;
        }

        /* Nouveaux styles pour la section commande modifiée */
        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid #ddd;
            font-size: 14px;
        }

        .form-group textarea {
            min-height: 80px;
        }

        #map, #tracking-map {
            width: 100%;
            height: 250px;
            border-radius: 10px;
            margin: 15px 0;
            border: 1px solid #ddd;
        }

        .map-container {
            position: relative;
        }

        .map-overlay {
            position: absolute;
            top: 10px;
            left: 10px;
            background: white;
            padding: 5px 10px;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            z-index: 1000;
            font-size: 12px;
        }

        .confirmation-code-container {
            background: #f5f5f5;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
        }

        .confirmation-code {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin: 15px 0;
        }

        .confirmation-code input {
            width: 50px;
            height: 60px;
            text-align: center;
            font-size: 24px;
            border: 2px solid #ddd;
            border-radius: 8px;
            -webkit-text-security: disc;
        }

        .confirmation-code input.show-code {
            -webkit-text-security: none;
        }

        .confirmation-code input:focus {
            border-color: var(--secondary);
            outline: none;
        }

        .toggle-code {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-top: 10px;
            font-size: 14px;
            color: #666;
        }

        .toggle-code input {
            margin-right: 8px;
        }

        .tracking-status {
            margin: 20px 0;
            padding: 15px;
            background: var(--light);
            border-radius: 10px;
            text-align: left;
        }

        .status-item {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }

        .status-item i {
            margin-right: 10px;
            color: var(--secondary);
        }

        .status-item.active i {
            color: var(--primary);
        }

        .status-item.active .status-text {
            font-weight: bold;
        }

        .status-line {
            height: 20px;
            width: 2px;
            background: #ddd;
            margin-left: 14px;
            margin-bottom: 5px;
        }

        .status-item:last-child .status-line {
            display: none;
        }

        /* Styles pour les marqueurs Leaflet */
        .leaflet-marker-icon {
            filter: hue-rotate(320deg) !important;
        }
    </style>
</head>
<body>
    <!-- Splash Screen comme une APK -->
    <div class="splash">
        <img src="logo.png" alt="Logo Taratasiko" class="splash-logo animate__animated animate__pulse animate__infinite">
        <p class="splash-text animate__animated animate__fadeIn">Chargement...</p>
    </div>
    
    <!-- App Container -->
    <div class="app-container">
        <!-- En-tête -->
        <header class="header animate__animated animate__fadeIn">
            <h1>Vos démarches administratives, simplifiées en un clic !</h1>
            <p>Confiez-nous vos urgences : dépôt de dossiers, retraits de documents</p>
            <a href="#commander" class="btn-primary">Commander un coursier maintenant</a>
        </header>
        
        <!-- Section Nos Valeurs -->
        <section class="section" id="valeurs">
            <h2><i class="fas fa-star"></i> Nos Valeurs</h2>
            <div class="values">
                <div class="value-item">
                    <i class="fas fa-clock"></i>
                    <h3>Urgence 24h</h3>
                </div>
                <div class="value-item">
                    <i class="fas fa-lock"></i>
                    <h3>Confidentialité</h3>
                </div>
                <div class="value-item">
                    <i class="fas fa-map-marker-alt"></i>
                    <h3>Suivi en temps réel</h3>
                </div>
                <div class="value-item">
                    <i class="fas fa-users"></i>
                    <h3>300+ coursiers</h3>
                </div>
            </div>
            <a href="#" class="btn-primary" style="margin-top: 10px;">Learn More</a>
        </section>
        
        <!-- Section Nos Services -->
        <section class="section" id="services">
            <h2><i class="fas fa-concierge-bell"></i> Nos Services</h2>
            <ul style="list-style: none;">
                <li style="margin-bottom: 10px; display: flex; align-items: center;">
                    <i class="fas fa-check-circle" style="color: var(--secondary); margin-right: 10px;"></i>
                    Service de délégation administrative
                </li>
                <li style="margin-bottom: 10px; display: flex; align-items: center;">
                    <i class="fas fa-check-circle" style="color: var(--secondary); margin-right: 10px;"></i>
                    Service de livraison de colis
                </li>
                <li style="margin-bottom: 10px; display: flex; align-items: center;">
                    <i class="fas fa-check-circle" style="color: var(--secondary); margin-right: 10px;"></i>
                    Publicité digitale
                </li>
            </ul>
        </section>
        
        <!-- Section Comment ça marche -->
        <section class="section" id="fonctionnement">
            <h2><i class="fas fa-question-circle"></i> Comment ça marche ?</h2>
            <div class="steps">
                <div class="step">
                    <div class="step-number">1</div>
                    <div>
                        <strong>Demande</strong>
                        <p>Remplissez le formulaire en ligne ou appelez-nous</p>
                    </div>
                </div>
                <div class="step">
                    <div class="step-number">2</div>
                    <div>
                        <strong>Confirmation</strong>
                        <p>Un coursier est assigné sous 1h</p>
                    </div>
                </div>
                <div class="step">
                    <div class="step-number">3</div>
                    <div>
                        <strong>Suivi</strong>
                        <p>Recevez des notifications en temps réel</p>
                    </div>
                </div>
                <div class="step">
                    <div class="step-number">4</div>
                    <div>
                        <strong>Livraison</strong>
                        <p>Document remis en main propre ou numérisé</p>
                    </div>
                </div>
            </div>
        </section>
        
        <!-- Section À Propos -->
        <section class="section" id="apropos">
            <h2><i class="fas fa-info-circle"></i> À Propos</h2>
            <p><strong>Notre histoire</strong></p>
            <p>Tout commence un mardi matin à Majunga, sous un soleil qui, franchement, n'avait aucune pitié. Sitraka, un étudiant en fin de licence, savoure ses dernières vacances quand une notification vient tout bouleverser...</p>
            
            <div class="full-story" id="fullStory">
                <p>« Clôture des candidatures Master 1 dans 3 jours. Dossier complet exigé. À déposer en main propre à Antananarivo. »</p>
                <p>Son cœur s'arrête. Ses yeux s'écarquillent. Il fait défiler la liste des pièces exigées : copie certifiée, extrait de naissance récent (pas celui de 2021), lettre de motivation imprimée (sur papier, pas PDF !). Et là, c'est le drame.</p>
                <p>Les options défilent :</p>
                <ul style="margin-left: 20px; margin-bottom: 15px;">
                    <li>Prendre un taxi-brousse à 17h, arriver 12h plus tard, affronter les guichets.</li>
                    <li>Appeler sa cousine ? Elle ne répond jamais.</li>
                    <li>Abandonner et rester à Majunga en méditant sur les choix de la vie ?</li>
                </ul>
                <p>Mais au lieu de céder à la panique, il a une illumination. Et si quelqu'un d'autre pouvait le faire pour lui ? Un héros, un ninja de l'administration, un... coursier administratif. À pied, s'il le faut.</p>
                <p>C'est ainsi qu'est née l'idée de cette entreprise : pour sauver des Sitraka en détresse administrative.</p>
            </div>
            
            <button class="btn-primary" id="btn-lire-suite" style="margin-top: 15px;">Lire la suite</button>
        </section>
        
        <!-- Section Pourquoi Nous -->
        <section class="section" id="pourquoi">
            <h2><i class="fas fa-thumbs-up"></i> Pourquoi nous ?</h2>
            <ul style="list-style: none;">
                <li style="margin-bottom: 15px; display: flex; align-items: flex-start;">
                    <i class="fas fa-check" style="color: var(--secondary); margin-right: 10px; margin-top: 3px;"></i>
                    <div>
                        <strong>Plus de 300 coursiers</strong> à votre disposition
                    </div>
                </li>
                <li style="margin-bottom: 15px; display: flex; align-items: flex-start;">
                    <i class="fas fa-check" style="color: var(--secondary); margin-right: 10px; margin-top: 3px;"></i>
                    <div>
                        <strong>Rapidité et professionnalisme</strong> sont nos alliés
                    </div>
                </li>
                <li style="margin-bottom: 15px; display: flex; align-items: flex-start;">
                    <i class="fas fa-check" style="color: var(--secondary); margin-right: 10px; margin-top: 3px;"></i>
                    <div>
                        Coursiers <strong>certifiés et formés</strong> à la confidentialité
                    </div>
                </li>
            </ul>
        </section>
        
        <!-- Section Tarifs -->
        <section class="section" id="tarifs">
            <h2><i class="fas fa-tags"></i> Nos Tarifs</h2>
            <p><strong>Tarifs variables selon la distance et la complexité</strong></p>
            <div style="margin: 20px 0;">
                <p><i class="fas fa-box" style="color: var(--secondary); margin-right: 10px;"></i> <strong>Livraison Colis :</strong> 5 500 Ar/km</p>
                <p><i class="fas fa-file-alt" style="color: var(--secondary); margin-right: 10px;"></i> <strong>Démarches Administratives :</strong> 10 000 Ar/h</p>
            </div>
            <a href="#commander" class="btn-primary">Demander un devis gratuit</a>
        </section>
        
        <!-- Section Commander (MODIFIÉE) -->
        <section class="section" id="commander">
            <h2><i class="fas fa-paper-plane"></i> Commander un coursier</h2>
            
            <div class="form-group">
                <label>Point de départ</label>
                <div style="padding: 12px; background: #f5f5f5; border-radius: 8px;">
                    33 Av. de L'Independance, Antananarivo 101
                </div>
            </div>
            
            <div class="form-group">
                <label for="dossier-type">Type de dossier administratif</label>
                <select id="dossier-type" class="form-control">
                    <option value="">Sélectionnez un type de dossier</option>
                    <option value="cni">Demande/renouvellement CNI (Bureau National d'Identification)</option>
                    <option value="passeport">Demande/renouvellement passeport (Direction de l'Immigration)</option>
                    <option value="extrait">Extrait de naissance (Mairie)</option>
                    <option value="casier">Casier judiciaire (Tribunal)</option>
                    <option value="scolarite">Attestation de scolarité (Établissement scolaire)</option>
                    <option value="diplome">Certificat/legalisation de diplôme (Ministère de l'Éducation)</option>
                    <option value="autre">Autre dossier administratif</option>
                </select>
            </div>
            
            <div class="form-group" id="autre-dossier-group" style="display: none;">
                <label for="autre-dossier">Précisez le type de dossier et l'adresse</label>
                <input type="text" id="autre-dossier" placeholder="Ex: Demande de permis de construire à la Commune Urbaine">
            </div>
            
            <div class="form-group">
                <label for="adresse-livraison">Adresse de livraison</label>
                <input type="text" id="adresse-livraison" placeholder="Ex: Lot II M 121 Bis, Antanimena">
            </div>
            
            <div class="form-group">
                <label for="instructions">Instructions spéciales</label>
                <textarea id="instructions" placeholder="Ex: Le colis est fragile, ou informations spécifiques pour la démarche administrative"></textarea>
            </div>
            
            <div class="map-container">
                <div class="map-overlay">Chargement de la carte...</div>
                <div id="map"></div>
            </div>
            
            <div id="montant-container" style="text-align: center; margin: 20px 0;">
                <p>Montant estimé :</p>
                <h2 style="color: var(--secondary); font-size: 28px;" id="montant">0 Ar</h2>
                <p style="font-size: 12px; color: #666;">(Frais de livraison + démarche administrative)</p>
            </div>
            
            <button class="btn-primary" id="btn-continuer">Continuer vers le paiement</button>
        </section>
        
        <!-- Section Paiement (MODIFIÉE) -->
        <section class="section" id="paiement" style="display: none;">
            <h2><i class="fas fa-money-bill-wave"></i> Paiement Mobile Money</h2>
            
            <div style="text-align: center; margin-bottom: 20px;">
                <h3 id="montant-paiement" style="font-size: 24px; color: var(--secondary);">0 Ar</h3>
                <p>Choisissez votre opérateur</p>
            </div>
            
            <div class="payment-methods">
                <div class="payment-method" data-operator="mvola">
                    <img src="mvola.png" alt="MVola">
                    <p>MVola</p>
                </div>
                <div class="payment-method" data-operator="airtel">
                    <img src="airtel-money.png" alt="Airtel Money">
                    <p>Airtel</p>
                    <p>Money</p>
                </div>
                <div class="payment-method" data-operator="orange">
                    <img src="orange-money.png" alt="Orange Money">
                    <p>Orange</p>
                    <p>Money</p>
                </div>
            </div>
            
            <div class="form-group">
                <label for="numero-tel">Numéro de téléphone</label>
                <input type="tel" id="numero-tel" placeholder="Votre numéro pour le paiement">
            </div>
            
            <div class="confirmation-code-container">
                <label>Code de confirmation (4 chiffres)</label>
                <div class="confirmation-code">
                    <input type="text" maxlength="1" pattern="[0-9]" inputmode="numeric" autocomplete="one-time-code">
                    <input type="text" maxlength="1" pattern="[0-9]" inputmode="numeric">
                    <input type="text" maxlength="1" pattern="[0-9]" inputmode="numeric">
                    <input type="text" maxlength="1" pattern="[0-9]" inputmode="numeric">
                </div>
                <div class="toggle-code">
                    <input type="checkbox" id="show-code"> <label for="show-code">Afficher le code</label>
                </div>
                <p style="font-size: 12px; color: #666; text-align: center; margin-top: 10px;">Vous recevrez un code par SMS pour confirmer le paiement</p>
            </div>
            
            <button class="btn-primary" id="btn-payer" style="margin-top: 20px;">Payer maintenant</button>
            <button class="btn-primary" id="btn-retour" style="margin-top: 10px; background: var(--primary);">Retour</button>
        </section>
        
        <!-- Section Confirmation -->
        <section class="section confirmation-section" id="confirmation">
            <div class="confirmation-icon">
                <i class="fas fa-check-circle"></i>
            </div>
            <h2>Commande confirmée</h2>
            <p>Votre coursier a été assigné</p>
            
            <div class="tracking-status">
                <div class="status-item active">
                    <i class="fas fa-check-circle"></i>
                    <div class="status-text">Commande confirmée</div>
                </div>
                <div class="status-line"></div>
                <div class="status-item">
                    <i class="far fa-circle"></i>
                    <div class="status-text">Coursier en route</div>
                </div>
                <div class="status-line"></div>
                <div class="status-item">
                    <i class="far fa-circle"></i>
                    <div class="status-text">Démarche en cours</div>
                </div>
                <div class="status-line"></div>
                <div class="status-item">
                    <i class="far fa-circle"></i>
                    <div class="status-text">Livraison en cours</div>
                </div>
                <div class="status-line"></div>
                <div class="status-item">
                    <i class="far fa-circle"></i>
                    <div class="status-text">Commande terminée</div>
                </div>
            </div>
            
            <div class="map-container">
                <div id="tracking-map"></div>
            </div>
            
            <div style="margin: 20px 0; text-align: left;">
                <h3 style="color: var(--primary); margin-bottom: 10px;">Détails du coursier</h3>
                <p><strong>Nom:</strong> Jean Rakoto</p>
                <p><strong>Téléphone:</strong> +261 34 12 345 67</p>
                <p><strong>Numéro de suivi:</strong> TRTSK-2024-0567</p>
            </div>
            
            <button class="btn-primary" id="btn-accueil">Retour à l'accueil</button>
        </section>
        
        <!-- Footer avec contacts -->
        <footer class="footer">
            <h3 style="margin-bottom: 15px;">Contactez-nous</h3>
            <p><i class="fas fa-map-marker-alt" style="margin-right: 10px;"></i> 33 Av. de L'Independance, Antananarivo 101</p>
            <p><i class="fas fa-phone" style="margin-right: 10px;"></i> <a class="contct" href="tel:+2612022221">20 222 21</a></p>
            <p><i class="fas fa-envelope" style="margin-right: 10px;"></i> <a class="contct" href="mailto:tana.admin@taratasiko.mg">tana.admin@taratasiko.mg</a></p>
            
            <h3 style="margin: 20px 0 10px;">Heures d'ouverture</h3>
            <p>Lundi-Vendredi: 09:00 - 15:30</p>
            <p>Samedi: 09:00 - 13:00</p>
            
            <a href="#commander" class="btn-primary" style="margin-top: 20px;">Commander un coursier maintenant</a>
            
            <p style="margin-top: 20px; font-size: 12px;">© 2024 Taratasiko - Tous droits réservés</p>
        </footer>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <!-- Leaflet Routing Machine -->
    <script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>
    <!-- Nominatim pour le géocodage -->
    <script src="https://unpkg.com/leaflet-control-geocoder@2.4.0/dist/Control.Geocoder.js"></script>

    <script>
        // Variables globales pour les cartes et marqueurs
        let map;
        let trackingMap;
        let departureMarker;
        let adminMarker;
        let deliveryMarker;
        let courierMarker;
        let courierRoute;
        let currentLeg = 0;
        let currentStep = 0;
        
        // Coordonnées fixes pour le point de départ (33 Av. de L'Independance)
        const departureCoords = [-18.9083, 47.5261];
        
        // Adresses des administrations à Madagascar avec coordonnées approximatives
        const adminLocations = {
            'cni': { name: 'Bureau National d\'Identification', coords: [-18.9145, 47.5316] },
            'passeport': { name: 'Direction de l\'Immigration', coords: [-18.9138, 47.5283] },
            'extrait': { name: 'Mairie d\'Antananarivo', coords: [-18.9088, 47.5254] },
            'casier': { name: 'Tribunal d\'Antananarivo', coords: [-18.9112, 47.5278] },
            'scolarite': { name: 'Ministère de l\'Éducation', coords: [-18.9101, 47.5302] },
            'diplome': { name: 'Ministère de l\'Enseignement Supérieur', coords: [-18.9095, 47.5297] }
        };

        document.addEventListener('DOMContentLoaded', function() {
            // Gestion de "Lire la suite"
            const btnLireSuite = document.getElementById('btn-lire-suite');
            const fullStory = document.getElementById('fullStory');
            
            btnLireSuite.addEventListener('click', function() {
                if (fullStory.style.display === 'block') {
                    fullStory.style.display = 'none';
                    btnLireSuite.textContent = 'Lire la suite';
                } else {
                    fullStory.style.display = 'block';
                    btnLireSuite.textContent = 'Réduire';
                }
            });
            
            // Gestion du type de dossier
            const dossierType = document.getElementById('dossier-type');
            const autreDossierGroup = document.getElementById('autre-dossier-group');
            
            dossierType.addEventListener('change', function() {
                if (this.value === 'autre') {
                    autreDossierGroup.style.display = 'block';
                } else {
                    autreDossierGroup.style.display = 'none';
                    updateMap();
                }
                calculerMontant();
            });
            
            // Initialisation des cartes
            function initMaps() {
                // Carte principale
                map = L.map('map').setView(departureCoords, 15);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>'
                }).addTo(map);
                
                // Carte de suivi
                trackingMap = L.map('tracking-map').setView(departureCoords, 15);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>'
                }).addTo(trackingMap);
                
                // Ajouter le marqueur de départ
                departureMarker = L.marker(departureCoords, {
                    icon: L.icon({
                        iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-blue.png',
                        iconSize: [25, 41],
                        iconAnchor: [12, 41],
                        popupAnchor: [1, -34]
                    }),
                    title: "Point de départ: 33 Av. de L'Independance"
                }).addTo(map);
                
                document.querySelector('.map-overlay').style.display = 'none';
            }
            
            // Initialiser les cartes
            initMaps();
            
            // Calcul du montant (simplifié pour la démo)
            function calculerMontant() {
                // Simulation de calcul de distance et durée
                const distance = Math.floor(Math.random() * 20) + 5; // 5-25 km
                const duree = dossierType.value ? (Math.random() * 3 + 1).toFixed(1) : 0; // 1-4 heures si dossier admin
                
                const montantLivraison = 5500 * distance;
                const montantDemarche = 10000 * duree;
                const montantTotal = montantLivraison + montantDemarche;
                
                document.getElementById('montant').textContent = montantTotal.toLocaleString('fr-FR') + ' Ar';
                document.getElementById('montant-paiement').textContent = montantTotal.toLocaleString('fr-FR') + ' Ar';
            }
            
            // Mise à jour de la carte lorsque les adresses changent
            function updateMap() {
                const dossierTypeValue = document.getElementById('dossier-type').value;
                const deliveryAddress = document.getElementById('adresse-livraison').value;
                
                if (!dossierTypeValue || !deliveryAddress) return;
                
                // Supprimer les anciens marqueurs s'ils existent
                if (adminMarker) map.removeLayer(adminMarker);
                if (deliveryMarker) map.removeLayer(deliveryMarker);
                if (courierRoute) map.removeControl(courierRoute);
                
                // Géocodage de l'adresse administrative (simplifié avec coordonnées fixes)
                const adminLocation = adminLocations[dossierTypeValue] || { 
                    name: document.getElementById('autre-dossier').value,
                    coords: [-18.9070, 47.5240] // Coordonnées par défaut pour "autre"
                };
                
                adminMarker = L.marker(adminLocation.coords, {
                    icon: L.icon({
                        iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png',
                        iconSize: [25, 41],
                        iconAnchor: [12, 41],
                        popupAnchor: [1, -34]
                    }),
                    title: adminLocation.name
                }).addTo(map).bindPopup(adminLocation.name);
                
                // Géocodage de l'adresse de livraison (simplifié avec coordonnées aléatoires proches)
                const deliveryCoords = [
                    adminLocation.coords[0] + (Math.random() * 0.01 - 0.005),
                    adminLocation.coords[1] + (Math.random() * 0.01 - 0.005)
                ];
                
                deliveryMarker = L.marker(deliveryCoords, {
                    icon: L.icon({
                        iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-green.png',
                        iconSize: [25, 41],
                        iconAnchor: [12, 41],
                        popupAnchor: [1, -34]
                    }),
                    title: "Livraison: " + deliveryAddress
                }).addTo(map).bindPopup("Livraison: " + deliveryAddress);
                
                // Calculer et afficher l'itinéraire
                courierRoute = L.Routing.control({
                    waypoints: [
                        L.latLng(departureCoords[0], departureCoords[1]),
                        L.latLng(adminLocation.coords[0], adminLocation.coords[1]),
                        L.latLng(deliveryCoords[0], deliveryCoords[1])
                    ],
                    routeWhileDragging: true,
                    showAlternatives: false,
                    addWaypoints: false,
                    draggableWaypoints: false,
                    fitSelectedRoutes: true,
                    lineOptions: {
                        styles: [{color: '#3366ff', opacity: 0.7, weight: 5}]
                    }
                }).addTo(map);
                
                // Ajuster la vue pour voir tous les points
                const featureGroup = L.featureGroup([departureMarker, adminMarker, deliveryMarker]);
                map.fitBounds(featureGroup.getBounds().pad(0.2));
            }
            
            // Simuler le suivi en temps réel après paiement
            function simulateTracking() {
                if (!departureMarker || !adminMarker || !deliveryMarker) return;
                
                // Supprimer l'ancien itinéraire de suivi s'il existe
                if (courierRoute) trackingMap.removeControl(courierRoute);
                if (courierMarker) trackingMap.removeLayer(courierMarker);
                
                // Créer un nouvel itinéraire pour la carte de suivi
                courierRoute = L.Routing.control({
                    waypoints: [
                        L.latLng(departureCoords[0], departureCoords[1]),
                        L.latLng(adminMarker.getLatLng().lat, adminMarker.getLatLng().lng),
                        L.latLng(deliveryMarker.getLatLng().lat, deliveryMarker.getLatLng().lng)
                    ],
                    routeWhileDragging: true,
                    show: false,
                    addWaypoints: false,
                    draggableWaypoints: false,
                    fitSelectedRoutes: false,
                    lineOptions: {
                        styles: [{color: '#3366ff', opacity: 0.5, weight: 5}]
                    }
                }).addTo(trackingMap);
                
                // Ajouter les marqueurs à la carte de suivi
                L.marker(departureCoords, {
                    icon: L.icon({
                        iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-blue.png',
                        iconSize: [25, 41],
                        iconAnchor: [12, 41],
                        popupAnchor: [1, -34]
                    })
                }).addTo(trackingMap).bindPopup("Départ");
                
                L.marker(adminMarker.getLatLng(), {
                    icon: L.icon({
                        iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png',
                        iconSize: [25, 41],
                        iconAnchor: [12, 41],
                        popupAnchor: [1, -34]
                    })
                }).addTo(trackingMap).bindPopup("Démarche administrative");
                
                L.marker(deliveryMarker.getLatLng(), {
                    icon: L.icon({
                        iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-green.png',
                        iconSize: [25, 41],
                        iconAnchor: [12, 41],
                        popupAnchor: [1, -34]
                    })
                }).addTo(trackingMap).bindPopup("Livraison");
                
                // Ajouter un marqueur mobile pour simuler le coursier
                courierMarker = L.marker(departureCoords, {
                    icon: L.icon({
                        iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-gold.png',
                        iconSize: [25, 41],
                        iconAnchor: [12, 41],
                        popupAnchor: [1, -34]
                    }),
                    zIndexOffset: 1000
                }).addTo(trackingMap).bindPopup("Coursier en route");
                
                // Obtenir les points de l'itinéraire
                courierRoute.on('routesfound', function(e) {
                    const routes = e.routes;
                    const route = routes[0];
                    const coordinates = route.coordinates;
                    
                    // Animation du marqueur
                    animateCourier(coordinates);
                });
                
                // Ajuster la vue pour voir tout l'itinéraire
                const featureGroup = L.featureGroup([
                    L.marker(departureCoords),
                    L.marker(adminMarker.getLatLng()),
                    L.marker(deliveryMarker.getLatLng())
                ]);
                trackingMap.fitBounds(featureGroup.getBounds().pad(0.2));
            }
            
            // Animation du marqueur du coursier
            function animateCourier(coordinates) {
				let i = 0;
				const totalPoints = coordinates.length;
				const interval = 1000; // Vitesse d'animation (ms)
				
				const stepDurations = {
					'Commande confirmée': 0.1,
					'Coursier en route': 0.3,
					'Démarche en cours': 0.4, 
					'Livraison en cours': 0.15,
					'Commande terminée': 0.05
				};
				
				const transitionPoints = {
					toCoursier: Math.floor(totalPoints * stepDurations['Commande confirmée']),
					toDemarche: Math.floor(totalPoints * (stepDurations['Commande confirmée'] + stepDurations['Coursier en route'])),
					toLivraison: Math.floor(totalPoints * (stepDurations['Commande confirmée'] + stepDurations['Coursier en route'] + stepDurations['Démarche en cours'])),
					toTermine: totalPoints - 1 // Modifié ici
				};

				function moveMarker() {
					// Modifier la condition pour inclure le dernier point
					if (i <= transitionPoints.toTermine) { // <= au lieu de <
						courierMarker.setLatLng([coordinates[i].lat, coordinates[i].lng]);
						
						if (i < transitionPoints.toCoursier) {
							setActiveStatus(0);
						} else if (i < transitionPoints.toDemarche) {
							setActiveStatus(1);
						} else if (i < transitionPoints.toLivraison) {
							setActiveStatus(2);
						} else if (i < transitionPoints.toTermine) {
							setActiveStatus(3);
						} else {
							// Dernier point atteint
							setActiveStatus(4); // Commande terminée
						}

						i++;
						setTimeout(moveMarker, interval);
					}
				}
				
				moveMarker();
			}
            
            // Mettre à jour la barre de statut en fonction de la progression
            function updateStatus(progress) {
                const statusItems = document.querySelectorAll('.status-item');
                
                if (progress < 0.25) {
                    // Statut 1 actif
                    setActiveStatus(0);
                } else if (progress < 0.5) {
                    // Statut 2 actif
                    setActiveStatus(1);
                } else if (progress < 0.75) {
                    // Statut 3 actif
                    setActiveStatus(2);
                } else if (progress < 0.95) {
                    // Statut 4 actif
                    setActiveStatus(3);
                } else {
                    // Statut 5 actif
                    setActiveStatus(4);
                }
            }
            
            function setActiveStatus(index) {
                const statusItems = document.querySelectorAll('.status-item');
                statusItems.forEach((item, i) => {
                    if (i <= index) {
                        item.classList.add('active');
                        item.querySelector('i').className = 'fas fa-check-circle';
                    } else {
                        item.classList.remove('active');
                        item.querySelector('i').className = 'far fa-circle';
                    }
                });
            }
            
            // Écouteurs pour la mise à jour de la carte
            document.getElementById('adresse-livraison')?.addEventListener('change', function() {
                updateMap();
                calculerMontant();
            });
            
            document.getElementById('autre-dossier')?.addEventListener('change', function() {
                updateMap();
                calculerMontant();
            });
            
            // Gestion du code de confirmation
            const codeInputs = document.querySelectorAll('.confirmation-code input');
            const showCodeCheckbox = document.getElementById('show-code');
            
            showCodeCheckbox.addEventListener('change', function() {
                codeInputs.forEach(input => {
                    if (this.checked) {
                        input.classList.add('show-code');
                    } else {
                        input.classList.remove('show-code');
                    }
                });
            });
            
            codeInputs.forEach((input, index) => {
                input.addEventListener('input', function() {
                    if (this.value.length === 1) {
                        if (index < codeInputs.length - 1) {
                            codeInputs[index + 1].focus();
                        } else {
                            this.blur();
                        }
                    }
                });
                
                input.addEventListener('keydown', function(e) {
                    if (e.key === 'Backspace' && this.value.length === 0 && index > 0) {
                        codeInputs[index - 1].focus();
                    }
                });
            });
            
            // Gestion du paiement
            const paymentMethods = document.querySelectorAll('.payment-method');
            paymentMethods.forEach(method => {
                method.addEventListener('click', function() {
                    paymentMethods.forEach(m => m.classList.remove('selected'));
                    this.classList.add('selected');
                });
            });
            
            // Navigation entre sections
            const btnContinuer = document.getElementById('btn-continuer');
            const btnRetour = document.getElementById('btn-retour');
            const btnPayer = document.getElementById('btn-payer');
            const btnAccueil = document.getElementById('btn-accueil');
            
            const commanderSection = document.getElementById('commander');
            const paiementSection = document.getElementById('paiement');
            const confirmationSection = document.getElementById('confirmation');
            
            btnContinuer.addEventListener('click', function() {
                if (!document.getElementById('dossier-type').value || 
                    !document.getElementById('adresse-livraison').value) {
                    alert('Veuillez remplir tous les champs obligatoires');
                    return;
                }
                
                commanderSection.style.display = 'none';
                paiementSection.style.display = 'block';
            });
            
            btnRetour.addEventListener('click', function() {
                paiementSection.style.display = 'none';
                commanderSection.style.display = 'block';
            });
            
            btnPayer.addEventListener('click', function() {
                const operator = document.querySelector('.payment-method.selected');
                const phoneNumber = document.getElementById('numero-tel').value;
                let codeComplete = true;
                
                codeInputs.forEach(input => {
                    if (!input.value) codeComplete = false;
                });
                
                if (!operator) {
                    alert('Veuillez sélectionner un opérateur de paiement');
                    return;
                }
                
                if (!phoneNumber) {
                    alert('Veuillez entrer votre numéro de téléphone');
                    return;
                }
                
                if (!codeComplete) {
                    alert('Veuillez entrer le code de confirmation complet');
                    return;
                }
                
                paiementSection.style.display = 'none';
                confirmationSection.style.display = 'block';
                
                // Simuler le suivi
                setTimeout(simulateTracking, 1000);
            });
            
            btnAccueil.addEventListener('click', function() {
                confirmationSection.style.display = 'none';
                commanderSection.style.display = 'block';
                
                // Réinitialisation du formulaire
                document.getElementById('dossier-type').value = '';
                document.getElementById('autre-dossier').value = '';
                document.getElementById('adresse-livraison').value = '';
                document.getElementById('instructions').value = '';
                document.getElementById('numero-tel').value = '';
                document.querySelectorAll('.payment-method').forEach(op => op.classList.remove('selected'));
                codeInputs.forEach(input => input.value = '');
                showCodeCheckbox.checked = false;
                codeInputs.forEach(input => input.classList.remove('show-code'));
                
                // Réinitialiser les statuts
                const statusItems = document.querySelectorAll('.status-item');
                statusItems.forEach((item, index) => {
                    if (index === 0) {
                        item.classList.add('active');
                        item.querySelector('i').className = 'fas fa-check-circle';
                    } else {
                        item.classList.remove('active');
                        item.querySelector('i').className = 'far fa-circle';
                    }
                });
            });
        });
    </script>
</body>
</html>
